---
layout: post
comments: true
title: MySQL 5.7 性能调优
categories: [mysql]
description: 
keywords: mysql
catalog: true
multilingual: false
tags: mysql
---

## 前言
最近在使用`new relic`监控发现有个sql update花了30s, 于是开启了数据库优化的路径...


### 慢sql查询log
mysql可以开启慢sql查询的log, 只要sql执行超过`long_query_time`时间, 同时影响超过`min_examined_row_limit`行数, 这个慢sql就会被记录. 
```sql
MySQL [(none)]> show variables like 'long_query_time';
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |  //对于文件精细度是毫秒, 对于表精细度是秒
+-----------------+-----------+
MySQL [(none)]> show variables like 'min_examined_row_limit';
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| min_examined_row_limit | 0     |
+------------------------+-------+
```
默认情况下, admin的管理查询语句是不会被记录在log, 但是可以被`log_slow_admin_statements`和`log_queries_not_using_indexes`修改配置.
慢log记录的执行时间是从获取锁的时间开始了, 直到运行完语句然后释放所有锁.所以获取锁的执行时间是不会被记录.
默认情况下, 慢查询log会记录所有使用非索引查询的慢语句, 这可能会导致log变得很大, 所以可以设置`log_queries_not_using_indexes`忽略这些使用非索引查询的语句. 或者使用`log_throttle_queries_not_using_indexes`来限制每分钟记录多少条非索引慢查询记录. mysql server使用如下控制参数顺序来控制一个查询语句是否写入慢查询log:
- 是否是管理sql语句, 或者开启了`log_slow_admin_statements`
- `long_query_time`必须被满足,或者`log_queries_not_using_indexes`被使能, 非索引查询语句也会被写入log
- 满足`min_examined_row_limit`行数
- 那些满足`log_throttle_queries_not_using_indexes`的查询
`log_timestamps`控制了写入慢查询log**文件**的时区, 但是不会影响通用查询log和写入数据库的log.
在cache中满足慢语句的sql是不会写入log, 默认情况下复制的从机也不会记录log.
